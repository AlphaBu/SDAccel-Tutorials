<table>
 <tr>
   <td align="center"><img src="https://www.xilinx.com/content/dam/xilinx/imgs/press/media-kits/corporate/xilinx-logo.png" width="30%"/><h1>2018.3 SDAccel™ Development Environment Tutorials</h1>
   <a href="https://github.com/Xilinx/SDAccel-Tutorials/branches/all">See other versions</a>
   </td>
 </tr>
 <tr>
 <td align="center"><h3>Controlling Vivado Implementation</h3>
 </td>
 </tr>
</table>

The Xilinx® Open Code Compiler (XOCC) is a command line compiler that takes your source code and runs it through the Vivado® implementation feature; this feature generates the bitstream (and other files) needed to program the FPGA-based accelerator boards. Sometimes, it is essential to use the advanced Vivado synthesis and implementation options to achieve your desired results, including timing closure.  
This section shows you how to control the Vivado flow when implementing your project, and guides you through the steps in GUI flow.  
>**NOTE**: This chapter applies to System Run. It may take more than one hour to compile the application.

The SDAccel™ environment provides two methods to control the Vivado flow:
* Before launching a compilation for a system run, you can pass the Vivado-specific synthesis and implementation options using the `--xp` XOCC compiler switch.
* If your application has already been compiled for a system run, then you can:
  1. Open the Vivado tools GUI.
  2. Optimize the design.
  3. Generate a new checkpoint.
  4. Import this checkpoint back to the SDAccel environment to finalize a new implementation.

## Using the `--xp` XOCC Compiler Switch
This scenario will describe how to:
 * Completely flatten hierarchy during RTL synthesis (i.e., specify _FLATTEN_HIERARCHY=full_).
 * Use NoTimingRelaxation directive during routing step: _DIRECTIVE=NoTimingRelaxation_

To pass these options to the Vivado flow using the `--xp` XOCC compiler switch, you must use the following syntax (you need to use a separate `--xp` switch per option):
* `--xp vivado_prop:run.my_rm_synth_1.{STEPS.SYNTH_DESIGN.ARGS.FLATTEN_HIERARCHY}={full}`
* `--xp vivado_prop:run.impl_1.{STEPS.ROUTE_DESIGN.ARGS.DIRECTIVE}={NoTimingRelaxation}`


These options must be specified for the XOCC linker in the SDAccel GUI.
1. Import the `Prj_5_Pipes` project by selecting the **File**->**Import...** menu.<!--ThomasB: the project name is non-descriptive and should be changed. Also, it is best to create projects from scratch rather than load existing ones.-->
2. In the prompt window, select **Xilinx/SDx Project**.
3. In the next window, choose **SDx project exported zip file**.
4. Click **Next**, browse to the project directory, and select `Prj_5_Pipes.zip`.
5. Click **OK**, and you will see that **Application Projects/Prj_5_Pipes** is already selected. Click **Finish**.  
6. In the Assistant tab, select **System**->**binary_container_1**, and from the right-click menu, click **Settings**:

  ![](images/vivado-implementation_snap1.PNG)

  The `--xp` options were specified for XOCC Linker Options:
  ![](images/vivado-implementation_snap2.PNG)
</br>
7. Click **Cancel** to close the window.  
8. Right-click `Prj_5_Pipes/System`, and then select **Build**.  

  During the implementation of the design, you can observe that these options were correctly propagated to the Vivado flow. The log messages generated by the Vivado RTL Synthesis are located in `Prj_5_Pipes/System/binary_container_1/logs/link/syn/my_rm_synth_1_runme.log`.  
  ![](images/vivado-implementation_snap4.PNG)

9. Open `Prj_5_Pipes/System/binary_container_1/logs/link/syn/my_rm_synth_1_runme.log`, and search for the `flatten_hierarchy` string. You should find:  
```
Command: synth_design -top pfm_dynamic -part xcvu9p-fsgd2104-2-i -flatten_hierarchy full -mode out_of_context  
```

  The log messages generated by the Vivado implementation feature are located in `Prj_5_Pipes/System/binary_container_1/logs/link/impl/impl_1_runme.log`  
![](images/vivado-implementation_snap5.PNG)
</br>
10. Open `Prj_5_Pipes/System/binary_container_1/logs/link/impl/impl_1_runme.log`, and search for the `NoTimingRelaxation` string. You should find:  
```
Command: route_design -directive NoTimingRelaxation
```

  You can review the log files to verify that the specified options in the SDAccel environment were successfully propagated to the Vivado flow.

## Running Vivado from the SDAccel GUI
If your application has already been compiled for a system run, you can open the Vivado GUI, load a synthesized or implemented design, interactively make several changes, generate a new checkpoint, and then export this checkpoint back to the SDAccel environment to finalize a new implementation.

>**IMPORTANT**: If your machine has less than 32 GB RAM, _only_ review the steps below _without actually running them_. Otherwise, there might be an out-of-memory issue.

1. With the Prj_5_Pipes project open, launch the Vivado tools by selecting **Xilinx**->**Vivado Integration**->**Open Vivado Project**:  
![](images/vivado-implementation_snap6.PNG)  
2. In the open Vivado project, select the synthesis run (`my_rm_synth_1`).
3. In the Synthesis Run Properties section, check the Options tab. The `flatten_hierarchy` option is set to `full`. This is a result of propagating the `flatten_hierarchy` option using the `--xp` switch.  
![](images/vivado-implementation_snap7.PNG)  
Similarly, check that the Vivado implementation feature settings display as expected.

  Let’s assume that you want to tune for timing in the Vivado implementation results.

4. Expand **IMPLEMENTATION**, and then expand **Open Implemented Design**.
5. To run the post-route physical synthesis, in the console window, type:  
```
phys_opt_design -directive AggressiveExplore
```  
![](images/vivado-implementation_snap8.PNG)  
 Timing is improved if there is only minor slack.
6. After this process is finished, write it back to route the `.dcp` file:
```
write_checkpoint -force prj/prj.runs/impl_1/pfm_top_wrapper_routed.dcp
```
>**NOTE**: You might need to change the path of the `.dcp` file. Check the working directory the in console by using the `pwd` command.
7. After the optimization completes, close the Vivado tools.

## Importing Vivado checkpoint back to SDAccel GUI

1. In the SDx™ environment, import the updated `.dcp` by selecting with **Xilinx**->**Vivado Integration**->**Import Vivado Checkpoint...**.  
After it is done, a window prompts you to confirm importing the `Vivado Settings` file.  
![](images/vivado-implementation_snap9.PNG)  
2. Click **Yes** to import the Vivado Settings file (`xocc.ini`) in the prompted window. Confirm that the `.dcp` and `.ini` files are imported, as shown below:  
![](images/vivado-implementation_snap10.PNG)
3. In the Assistant window, right-click **Prj_5_Pipes/System**, and then select **Build**.  

You will see the incremental flow continuing to the Vivado implementation flow and generating bitstream.

<hr/>
<p align="center"><sup>Copyright&copy; 2019 Xilinx</sup></p>
